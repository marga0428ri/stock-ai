import pandas as pd
import yfinance as yf
from datetime import datetime
from sklearn.ensemble import RandomForestClassifier

# --- 1. ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ï¼ˆå…ƒ fetch_data.pyï¼‰ ---
def get_data(ticker="AAPL", start="2015-01-01"):
    print(f"Fetching data for {ticker}...")
    df = yf.download(ticker, start=start, progress=False)
    
    # ã‚¨ãƒ©ãƒ¼å›é¿ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ãŒ2æ®µã«ãªã£ã¦ã„ã‚‹å ´åˆã®ä¿®æ­£
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = df.columns.get_level_values(0)
        
    return df

# --- 2. AIäºˆæ¸¬æ©Ÿèƒ½ï¼ˆç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ï¼‰ ---
def add_features(df):
    df = df.copy()
    # å¤‰åŒ–ç‡
    df["Return"] = df["Close"].pct_change()
    # ç§»å‹•å¹³å‡
    df["SMA_5"] = df["Close"].rolling(window=5).mean()
    df["SMA_25"] = df["Close"].rolling(window=25).mean()
    # ä¹–é›¢ç‡
    df["Deviation"] = (df["SMA_5"] - df["SMA_25"]) / df["SMA_25"]
    
    # ç›®çš„å¤‰æ•°ï¼ˆæ˜æ—¥ã®çµ‚å€¤ãŒä¸ŠãŒã‚‹ã‹ï¼Ÿï¼‰
    df["Target"] = (df["Close"].shift(-1) > df["Close"]).astype(int)
    
    df.dropna(inplace=True)
    return df

# --- 3. çµæœæ›¸ãè¾¼ã¿æ©Ÿèƒ½ ---
def update_readme(prediction_text, confidence):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    content = f"""# ğŸ“ˆ Stock Prediction AI
    
**Latest Prediction for AAPL**
- ğŸ•’ Updated: {now} (UTC)
- ğŸ”® Prediction: **{prediction_text}**
- ğŸ¤– Confidence: {confidence:.1f}%

---
*This prediction is automatically generated by GitHub Actions.*
"""
    with open("README.md", "w", encoding="utf-8") as f:
        f.write(content)
    print("README.md has been updated!")

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def main():
    # 1. ãƒ‡ãƒ¼ã‚¿å–å¾—
    try:
        df = get_data("AAPL")
        if df.empty:
            print("Error: No data fetched.")
            return
    except Exception as e:
        print(f"Error fetching data: {e}")
        return

    # 2. ãƒ‡ãƒ¼ã‚¿åŠ å·¥
    df_processed = add_features(df)
    
    features = ["Return", "Deviation"]
    X = df_processed[features]
    y = df_processed["Target"]
    
    # å­¦ç¿’ï¼ˆæ˜¨æ—¥ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ï¼‰ã¨äºˆæ¸¬ï¼ˆä»Šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ï¼‰
    X_train = X.iloc[:-1]
    y_train = y.iloc[:-1]
    X_latest = X.iloc[-1:]
    
    # 3. ãƒ¢ãƒ‡ãƒ«ä½œæˆ & å­¦ç¿’
    model = RandomForestClassifier(n_estimators=100, random_state=42)
    model.fit(X_train, y_train)
    
    # 4. äºˆæ¸¬å®Ÿè¡Œ
    prediction = model.predict(X_latest)[0]
    probability = model.predict_proba(X_latest)[0]
    
    result = "UP ğŸ“ˆ" if prediction == 1 else "DOWN ğŸ“‰"
    confidence = probability[prediction] * 100
    
    print(f"Prediction: {result} ({confidence:.1f}%)")
    
    # 5. READMEæ›´æ–°
    update_readme(result, confidence)

if __name__ == "__main__":
    main()
