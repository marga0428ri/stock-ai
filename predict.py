import pandas as pd
import yfinance as yf
from datetime import datetime, timedelta
from sklearn.ensemble import RandomForestClassifier

# --- 1. ãƒ‡ãƒ¼ã‚¿å–å¾— ---
def get_data(ticker="AAPL", start="2015-01-01"):
    # æœ€æ–°ã®æ—¥ä»˜ã¾ã§å–å¾—
    df = yf.download(ticker, start=start, progress=False)
    if isinstance(df.columns, pd.MultiIndex):
        df.columns = df.columns.get_level_values(0)
    return df

# --- 2. ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ï¼ˆ5æ—¥å¾Œäºˆæ¸¬ç”¨ã«å¼·åŒ–ï¼‰ ---
def add_features(df):
    df = df.copy()
    
    # å¤‰åŒ–ç‡ï¼ˆãƒªã‚¿ãƒ¼ãƒ³ï¼‰
    df["Return"] = df["Close"].pct_change()
    
    # ç§»å‹•å¹³å‡ç·šï¼ˆçŸ­æœŸãƒ»ä¸­æœŸãƒ»é•·æœŸï¼‰
    df["SMA_5"] = df["Close"].rolling(window=5).mean()
    df["SMA_20"] = df["Close"].rolling(window=20).mean()
    df["SMA_60"] = df["Close"].rolling(window=60).mean()
    
    # ä¹–é›¢ç‡ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰ã®å¼·ã•ï¼‰
    df["Deviation_Short"] = (df["Close"] - df["SMA_5"]) / df["SMA_5"]
    df["Deviation_Mid"] = (df["Close"] - df["SMA_20"]) / df["SMA_20"]
    
    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆå€¤å‹•ãã®æ¿€ã—ã•ï¼‰
    df["Volatility"] = df["Close"].pct_change().rolling(window=5).std()
    
    # â˜…ã“ã“ãŒãƒ—ãƒ­ä»•æ§˜ï¼ã€Œ5æ—¥å¾Œã€ã‚’äºˆæ¸¬ã™ã‚‹
    # 5æ—¥å¾Œã®çµ‚å€¤ãŒã€ä»Šæ—¥ã‚ˆã‚Šã€Œ1%ä»¥ä¸Šã€ä¸ŠãŒã£ã¦ã„ã‚Œã°å‹ã¡(1)ã€ãã‚Œä»¥å¤–ã¯è² ã‘(0)
    # â€»å˜ã«ä¸ŠãŒã‚‹ã ã‘ã§ãªãã€Œã‚ã‚‹ç¨‹åº¦ã—ã£ã‹ã‚Šä¸ŠãŒã‚‹ã€ã“ã¨ã‚’ç‹™ã†
    prediction_days = 5
    threshold = 0.01 # 1%
    
    future_return = (df["Close"].shift(-prediction_days) - df["Close"]) / df["Close"]
    df["Target"] = (future_return > threshold).astype(int)
    
    df.dropna(inplace=True)
    return df

# --- 3. READMEæ›´æ–°æ©Ÿèƒ½ ---
def update_readme(prediction_text, confidence, latest_price):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    
    content = f"""# ğŸ“ˆ Stock Prediction AI (Professional Ver.)
    
## ğŸ¯ Prediction for AAPL (5-Day Horizon)
AI predicts whether the price will rise **>1%** in the next 5 days.

- ğŸ•’ **Updated:** {now} (UTC)
- ğŸ’° **Latest Price:** ${latest_price:.2f}
- ğŸ”® **Prediction:** **{prediction_text}**
- ğŸ¤– **Confidence:** {confidence:.1f}%

---
### ğŸ“Š Model Info
- **Target:** 5 days later (Event Prediction)
- **Model:** Random Forest Classifier
- *Automatically generated by GitHub Actions*
"""
    with open("README.md", "w", encoding="utf-8") as f:
        f.write(content)

# --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
def main():
    # ãƒ‡ãƒ¼ã‚¿å–å¾—
    try:
        df = get_data("AAPL")
        if df.empty: return
    except: return

    latest_price = df["Close"].iloc[-1]
    
    # ãƒ‡ãƒ¼ã‚¿åŠ å·¥
    df_processed = add_features(df)
    
    features = ["Return", "Deviation_Short", "Deviation_Mid", "Volatility"]
    X = df_processed[features]
    y = df_processed["Target"]
    
    # å­¦ç¿’ç”¨ï¼ˆ5æ—¥å‰ã¾ã§ï¼‰ã¨äºˆæ¸¬ç”¨ï¼ˆæœ€æ–°ï¼‰
    # â€»5æ—¥å¾Œäºˆæ¸¬ãªã®ã§ã€æ­£è§£ãŒã‚ã‹ã£ã¦ã„ã‚‹ã®ã¯5æ—¥å‰ã¾ã§
    X_train = X.iloc[:-5]
    y_train = y.iloc[:-5]
    X_latest = X.iloc[-1:]
    
    # ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
    # æœ¨ã®æ·±ã•ã‚’åˆ¶é™ã—ã¦ã€Œéå­¦ç¿’ï¼ˆæš—è¨˜ï¼‰ã€ã‚’é˜²ã
    model = RandomForestClassifier(n_estimators=200, max_depth=5, random_state=42)
    model.fit(X_train, y_train)
    
    # äºˆæ¸¬
    prediction = model.predict(X_latest)[0]
    probability = model.predict_proba(X_latest)[0]
    
    # çµæœã®åˆ¤å®š
    if prediction == 1:
        result = "UP ğŸš€ (Strong Buy)"
        confidence = probability[1] * 100
    else:
        result = "NEUTRAL / DOWN âœ‹ (Wait)"
        confidence = probability[0] * 100
    
    print(f"Prediction: {result} ({confidence:.1f}%)")
    
    update_readme(result, confidence, latest_price)

if __name__ == "__main__":
    main()
